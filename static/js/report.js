const blankImageEncoded = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8z/C/HgAGgwJ/lK3Q6wAAAABJRU5ErkJggg==';

// ----------------------------------------------------------------
// INITIALIZE pdfMake
// ----------------------------------------------------------------

pdfMake.fonts = {
  Ubuntu: {
    normal: 'http://127.0.0.1:5000/static/fonts/Ubuntu/Ubuntu-Regular.ttf',
    bold: 'http://127.0.0.1:5000/static/fonts/Ubuntu/Ubuntu-Bold.ttf',
    italics: 'http://127.0.0.1:5000/static/fonts/Ubuntu/Ubuntu-Italic.ttf',
    bolditalics: 'http://127.0.0.1:5000/static/fonts/Ubuntu/Ubuntu-BoldItalic.ttf'
  }
};
pdfMake.tableLayouts = {
  details: {
    hLineWidth: function () {
      return 1;
    },
    hLineColor: function () {
      return '#e0e0e0';
    },
    vLineWidth: function () {
      return 1;
    },
    vLineColor: function () {
      return '#e0e0e0';
    }
  }
};

async function generateReport(results) {
  let resultsBody = [];
  for (const [key, param] of Object.entries(resultsParameters)) {
    console.log({key});
    console.log(Object.keys(results));
    if (!Object.keys(results).includes(key)) {
      continue;
    }

    const value = numeral(results[key]).value();

    let measurementText = "";
    if (key in results) {
      measurementText = `${param.getMeasurement(value)}`;
    }

    let quantityText = [measurementText]
    if (key == "tcp_ttr") {
      const relative = value < 1 ? 1 / value : value;
      quantityText.push({
        text: `${numeral(relative).format('0.[00]')} times ${value < 1 ? "faster" : "slower"} than ideal`,
        fontSize: 9,
        color: '#808080'
      });
    }

    resultsBody.push([
      {
        text: param.name,
        fontSize: 11
      },
      {
        text: quantityText,
        fontSize: 11
      }
    ]);
  }
  console.log({resultsBody});

  // ----------------------------------------------------------------
  // LAYOUT REPORT
  // ----------------------------------------------------------------

  const ntcLogoData = await getBase64ImageFromURLAsync('static/images/ntc_logo.png');
  var docDefinition = {
    pageMargins: [0.5 * 72, 0.5 * 72, 0.5 * 72, 0.5 * 72],
    defaultStyle: {
      font: 'Ubuntu'
    },
    content: [
      {
        columns: [
          {
            image: ntcLogoData,
            width: 0.9 * 72,
            height: 0.9 * 72,
          },
          [
            {
              text: "Republic of the Philippines",
              lineHeight: 1.15,
              margin: [0, 6, 0, 0]
            },
            {
              text: "NATIONAL TELECOMMUNICATIONS COMMISSION",
              lineHeight: 1.15,
              bold: true
            },
            // {
            //   text: "Address",
            //   lineHeight: 1.15,
            // }
          ]
        ],
        columnGap: 18,
        margin: [0, 0, 0, 12]
      },
      {
        text: "RFC-6349 RESULTS",
        fontSize: 14,
        alignment: 'center',
        bold: true,
        margin: [0, 0, 0, 12]
      },
      {
        columns: [
          {
            width: '58%',
            layout: 'details',
            table: {
              headerRows: 0,
              widths: ['45%', '55%'],
              body: [
                [
                  'Test Mode',
                  'Bidirectional'
                ],
                [
                  'Internet Subscription Rate (ISR)',
                  '35 Mbps'
                ],
                [
                  'Network Connection Type',
                  'Wi-Fi'
                ],
                [
                  'Test Server',
                  'UP Diliman Department of Computer Science Test Server'
                ],
                [
                  'Coordinates',
                  '14.0134, 121.01294'
                ],
              ]
            }
          },
          {
            width: '42%',
            layout: 'details',
            table: {
              headerRows: 0,
              widths: ['auto', '*'],
              body: [
                [
                  'Started On',
                  '2022-01-24 17:10:19'
                ],
                [
                  'Finished On',
                  '2022-01-24 17:11:44'
                ],
                [
                  'Duration',
                  '1m 25s'
                ],
                [
                  'Generated By',
                  'sample_user'
                ],
                [
                  'Generated On',
                  '2022-01-24 17:14:28'
                ],
              ]
            },
          },
        ],
        columnGap: 12,
        margin: [0, 0, 0, 12]
      },
      {
        columns: [
          [
            {
              image: _throughputChartImgURI['download'] ?? blankImageEncoded,
              height: 40,
              width: 256,
              margin: [0, 0, 0, 12]
            },
            {
              image: _transferChartImgURI['download'] ?? blankImageEncoded,
              height: 56,
              width: 256,
              margin: [0, 0, 0, 12]
            },
            {
              layout: 'details',
              table: {
                headerRows: 0,
                widths: ['auto', '*'],
                body: resultsBody
              }
            }
          ],
          [
            {
              image: _throughputChartImgURI['download'] ?? blankImageEncoded,
              height: 36,
              width: 256,
              margin: [0, 0, 0, 12]
            },
            {
              image: _transferChartImgURI['download'] ?? blankImageEncoded,
              height: 56,
              width: 256,
              margin: [0, 0, 0, 12]
            },
            {
              layout: 'details',
              table: {
                headerRows: 0,
                widths: ['auto', '*'],
                body: resultsBody
              }
            }
          ]
        ]
      }
    ]
  };

  // ----------------------------------------------------------------
  // GENERATE PDF
  // ----------------------------------------------------------------
  
  const pdfDocGenerator = pdfMake.createPdf(docDefinition);
  pdfDocGenerator.getDataUrl((dataUrl) => {
    const iframe = document.querySelector('#pdfPreview');
    iframe.src = dataUrl;
  });
}

async function getBase64ImageFromURLAsync(url) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.setAttribute("crossOrigin", "anonymous");
    img.onload = () => {
      const canvas = document.createElement("canvas");
      canvas.width = img.width;
      canvas.height = img.height;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0);
      const dataURL = canvas.toDataURL("image/png");
      resolve(dataURL);
    };
    img.onerror = error => {
      reject(error);
    };
    img.src = url;
  });
}