<div class="p-3">
  <h6 class="card-title text-bold text-secondary">THROUGHPUT TEST</h6>
  <div id="{{ method }}-isr-thpt-chart" class="d-flex inline-block align-items-center">
  </div>
  <div id="{{ method }}-transfer-chart" class="d-flex inline-block align-items-center">
  </div>
  <div class="mx-2">
    <table id="{{ method }}-measurement-results" class="table table-sm table-bordered table-hover caption-top mt-4" aria-hidden="true">
      <tbody>
      </tbody>
    </table>
  </div>
</div>

<script>
  (function () {
    const results = JSON.parse('{{ results | tojson|safe }}');
    const method = '{{ method | safe }}';
  
    const ntcBlueColor = '#0038a7';
    const ntcRedColor = '#CE1127';
    const greenColor = '#38A700';
    
    const uploadColor = '#4824FF';
    const downloadColor = '#008ca7';
    const directionColor = method == 'upload' ? uploadColor : downloadColor;
  
    $(`#${method}-measurement-results tbody`).html('');
    for (const [key, param] of Object.entries(resultsParameters)) {
      const value = numeral(results[key]).value();
  
      let measurementText = "";
      if (key in results) {
        measurementText = `${param.getMeasurement(value)}`;
      }
  
      let quantityHtml = `<td>
        ${measurementText}
      </td>`;
      switch (key) {
        case "tcp_ttr":
          const relative = value < 1 ? 1 / value : value;
          quantityHtml = `<td>
            <div>
              ${measurementText}<small class="text-muted ps-1">${value === 1 ? "Same as ideal" : `${numeral(relative).format('0.[000]')} times ${value < 1 ? "faster" : "slower"} than ideal`}</small>
            </div>
          </td>`;
          break;
        case "buf_delay":
          const absolute = Math.abs(value);
          quantityHtml = `<td>
            <div>
              ${measurementText}<small class="text-muted ps-1">${value === 0 ? "No" : `${numeral(absolute).format('0.[00]')}%`} ${value >= 0 ? "increase" : "decrease"} in delay of RTT</small>
            </div>
          </td>`;
          break;
      }
      $(`#${method}-measurement-results tbody`).append(`
        <tr>
          <td style="color: '${directionColor}'">${param.name}</td>
          ${quantityHtml}
        </tr>
      `);
    }
    
    $(`.${method}.card-title`).css('color', directionColor);
  
    renderThoughputComparisonChart(results);
    renderTransferComparisonChart(results);
  
    console.log(results);
  
    function renderThoughputComparisonChart({thpt_avg, thpt_ideal}) {
      const thptAvgColor = ntcBlueColor;
  
      const options = getThroughputChartOptions(method, thpt_avg, thpt_ideal);
      const chart = new ApexCharts(document.querySelector(`#${method}-isr-thpt-chart`), options);

      chart.render().then(() => {
        setTimeout(function () {
          chart.dataURI({scale: 3}).then(({imgURI}) => {
            chartImageUris.throughputCharts[method] = imgURI;
          });
        }, 500);
      });
    }
  
    function renderTransferComparisonChart({transfer_avg, transfer_ideal}) {
      const transferColor = ntcBlueColor;
  
      const options = getTransferChartOptions(method, transfer_avg, transfer_ideal);
      const chart = new ApexCharts(document.querySelector(`#${method}-transfer-chart`), options);

      chart.render().then(() => {
        setTimeout(function () {
          chart.dataURI({scale: 3}).then(({imgURI}) => {
            chartImageUris.transferCharts[method] = imgURI;
          });
        }, 500);
      });
    }
  })();
</script>