<div class="p-3">
  <h6 class="card-title text-bold text-secondary">THROUGHPUT TEST</h6>
  <div id="{{ direction }}-isr-thpt-chart" class="d-flex inline-block align-items-center">
  </div>
  <div id="{{ direction }}-transfer-chart" class="d-flex inline-block align-items-center">
  </div>
  <div class="mx-2">
    <table id="{{ direction }}-measurement-results" class="table table-sm table-bordered table-hover caption-top mt-4" aria-hidden="true">
      <tbody>
      </tbody>
    </table>
  </div>
</div>

<script>
  (function () {
    const results = JSON.parse('{{ results | tojson|safe }}');
    const direction = '{{ direction | safe }}';

    const ntcBlueColor = '#0038a7';
    const ntcRedColor = '#CE1127';
    const greenColor = '#38A700';
    
    const uploadColor = '#4824FF';
    const downloadColor = '#008ca7';
    const directionColor = direction == 'upload' ? uploadColor : downloadColor;

    $(`#${direction}-measurement-results tbody`).html('');
    for (const [key, param] of Object.entries(resultsParameters)) {
      const value = numeral(results[key]).value();

      let measurementText = "";
      if (key in results) {
        measurementText = `${param.getMeasurement(value)}`;
      }

      let quantityHtml = `<td>
        ${measurementText}
      </td>`;
      if (key == "tcp_ttr") {
        const relative = value < 1 ? 1 / value : value;
        if (value !== 1) {
          quantityHtml = `<td>
            <div>
              ${measurementText}<small class="text-muted ps-1">${numeral(relative).format('0.[00]')} times ${value < 1 ? "faster" : "slower"}</small>
            </div>
          </td>`;
        }
      }
      $(`#${direction}-measurement-results tbody`).append(`
        <tr>
          <td style="color: '${directionColor}'">${param.name}</td>
          ${quantityHtml}
        </tr>
      `);
    }
    
    $(`.${direction}.card-title`).css('color', directionColor);

    renderThoughputComparisonChart(results);
    renderTransferComparisonChart(results);

    console.log(results);

    function renderThoughputComparisonChart({thpt_avg, thpt_ideal}) {
      const thptAvgColor = ntcBlueColor;

      const options = getThroughputChartOptions(direction, thpt_avg, thpt_ideal);
      const chart = new ApexCharts(document.querySelector(`#${direction}-isr-thpt-chart`), options);
      chart.render();
      /*chart.render().then(() => {
        setTimeout(function () {
          chart.dataURI({scale: 0.9}).then(({imgURI}) => {
            _thoughputChartImgURI = imgURI;
          });
        }, 500);
      });*/
    }

    function renderTransferComparisonChart({transfer_avg, transfer_ideal}) {
      const transferColor = ntcBlueColor;

      const options = getTransferChartOptions(direction, transfer_avg, transfer_ideal);
      const chart = new ApexCharts(document.querySelector(`#${direction}-transfer-chart`), options);
      chart.render();
      /*chart.render().then(() => {
        setTimeout(function () {
          chart.dataURI({scale: 0.9}).then(({imgURI}) => {
            _transferChartImgURI = imgURI;
          });
        }, 500);
      });;*/
    }
  })();
</script>