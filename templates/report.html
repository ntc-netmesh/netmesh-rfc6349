{% extends 'base.html' %}

{% block head %}
{{ super() }}
{% endblock %}

{% block body %}
{{ super() }}
<div>
  <div>
    <div class="row gx-3 mb-3">
      <div class="col-auto">
        <img src="{{ url_for('static', filename='images/ntc_logo.png') }}" width="90" height="90" />
      </div>
      <div class="col">
        <div class="h5 mb-0 fw-normal"><small>REPUBLIC OF THE PHILIPPINES</small></div>
        <div class="h5"><small>NATIONAL TELECOMMUNICATIONS COMMISSION</small></div>
      </div>
    </div>
    <h5 class="text-center mb-3">RFC-6349 TEST RESULTS</h5>
    <h6 class="text-left mb-2">TEST DETAILS</h6>
    <h6 class="text-left mb-2 small text-secondary">Test Inputs</h6>
    <table class="table table-sm table-bordered w-auto">
      <tbody class="small" >
        <tr>
          <td>Internet Subscription Rate (ISR)</td>
          <td>{{ cir }} Mbps</td>
        </tr>
        <tr>
          <td>Network Connection Type</td>
          <td>{{ net }}</td>
        </tr>
        <tr>
          <td>Test Server</td>
          <td>{{ server_name }}</td>
        </tr>
        <tr>
          <td>Cooordinates</td>
          <td>{{lon}}, {{lat}}</td>
        </tr>
      </tbody>
    </table>
    <h6 class="text-left mb-2 small text-secondary">Test Time</h6>
    <table class="table table-sm table-bordered w-auto">
      <tbody class="small">
        <tr>
          <td>Test Mode</td>
          <td>{{ mode.capitalize() }}</td>
        </tr>
        <tr>
          <td>Started On</td>
          <td>{{ started_on }}</td>
        </tr>
        <tr>
          <td>Finished On</td>
          <td>{{ finished_on }}</td>
        </tr>
        <tr>
          <td>Duration</td>
          <td>{{ duration }}</td>
        </tr>
      </tbody>
    </table>
    <h6 class="text-left mb-2 small text-secondary">Test Report Generation</h6>
    <table class="table table-sm table-bordered w-auto">
      <tbody class="small">
        <tr>
          <td>Generated by</td>
          <td>{{ username }}</td>
        </tr>
        <tr>
          <td>Generated on</td>
          <td>{{ generated_on }}</td>
        </tr>
      </tbody>
    </table>
    <!-- <div class="row gx-2">
      <div class="col-auto">
        
      </div>
      <div class="col">
        
      </div>
    </div> -->
    <h6 id="test-results-title" class="text-left mb-2">TEST RESULTS</h6>
    <div id="test-results">
      {% for direction in directions %}
        <h6 id="{{ direction }}-test-title" class="text-left mb-2 small">{{ direction.capitalize() }} Test</h6>
        <div class="px-2">
          <h6 class="text-left mb-2 text-secondary small">THROUGHPUT TEST</h6>
          <div id="{{ direction }}-thpt-chart-report"></div>
          <div id="{{ direction }}-transfer-chart-report"></div>
          <!-- <img id="{{ direction }}-img-thpt-chart"/>
          <img id="{{ direction }}-img-transfer-chart" height="144"/> -->
          <table id="{{ direction }}-test-results" class="small table table-sm w-auto">
            <tbody class="small">
              <!-- <tr>
                <td>Internet Subscription Rate (ISR)</td>
                <td>35 Mbps</td>
              </tr>
              <tr>
                <td>Network Connection Type</td>
                <td>Ethernet</td>
              </tr>
              <tr>
                <td>Test Server</td>
                <td>ASTI COARE Test Server</td>
              </tr>
              <tr>
                <td>Cooordinates</td>
                <td>14.1254, 121.2564</td>
              </tr> -->
            </tbody>
          </table>
        </div>
      {% endfor %}
    </div>
  </div>
</div>

<script>
  (function () {
    const directions = JSON.parse('{{ directions_text | safe }}');
    const results = JSON.parse('{{ results | tojson|safe }}');
    console.log("directions");
    console.log(directions);

    for (const direction of directions) {
      console.log(results);
      console.log(direction);
      const dResults = results[direction];
      console.log(dResults);

      for (const [key, param] of Object.entries(resultsParameters)) {
        if (!(key in dResults)) {
          continue;
        }
  
        const value = numeral(dResults[key]).value();
  
        let measurementText = "";
        if (key in dResults) {
          measurementText = `${param.getMeasurement(value)}`;
        }
  
        let quantityHtml = `<td>
          ${measurementText}
        </td>`;
        if (key == "tcp_ttr") {
          const relative = value < 1 ? 1 / value : value;
          if (value !== 1) {
            quantityHtml = `<td>
              <div>
                ${measurementText}<small class="text-muted ps-1">${numeral(relative).format('0.[00]')} times ${value < 1 ? "faster" : "slower"}</small>
              </div>
            </td>`;
          }
        }
        $(`#${direction}-test-results tbody`).append(`
          <tr>
            <td>${param.name}</td>
            ${quantityHtml}
          </tr>
        `);
      }

      renderThoughputComparisonChart(dResults, direction);
      renderTransferComparisonChart(dResults, direction);
    }

    function renderThoughputComparisonChart({thpt_avg, thpt_ideal}, direction) {
      const thptAvgColor = ntcBlueColor;

      const options = getThroughputChartOptions(direction, thpt_avg, thpt_ideal);
      options.chart.height = 90;
      options.chart.width = 480;
      console.log("thpt chart direction: " + direction);
      const chart = new ApexCharts(document.querySelector(`#${direction}-thpt-chart-report`), options);
      chart.render();
    }

    function renderTransferComparisonChart({transfer_avg, transfer_ideal}, direction) {
      const transferColor = ntcBlueColor;

      const options = getTransferChartOptions(direction, transfer_avg, transfer_ideal);
      options.chart.height = 128;
      options.chart.width = 480;
      console.log("transfer chart direction: " + direction);
      const chart = new ApexCharts(document.querySelector(`#${direction}-transfer-chart-report`), options);
      chart.render();
    }
  })();
</script>
{% endblock %}